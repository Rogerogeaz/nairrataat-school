<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Nairrataat School â€“ Student Register</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:'Poppins',sans-serif}
body{margin:0;background:#f3f4f6;padding:12px}

/* SPLASH */
#splash{position:fixed;inset:0;background:#1e88e5;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999}
#splash img{width:140px;animation:zoom 2s ease}
#splash h1{color:#fff;margin-top:15px}
@keyframes zoom{from{transform:scale(.5);opacity:0}to{transform:scale(1);opacity:1}}

.container{max-width:480px;margin:auto;background:#fff;border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
.header{text-align:center}
.header h2{color:#1e88e5;margin:5px 0}
.header p{font-size:13px;color:#666}

.photo-box{text-align:center;margin:10px 0}
.photo-box img{width:120px;height:120px;border-radius:50%;object-fit:cover;border:3px solid #1e88e5}

.input-box{display:flex;align-items:center;background:#f2f2f2;border-radius:10px;padding:10px;margin-top:10px}
.input-box i{color:#1e88e5;margin-right:10px}
.input-box input,.input-box select{border:none;background:none;width:100%;outline:none;font-size:14px}

.btn{width:100%;padding:14px;border:none;border-radius:12px;margin-top:12px;font-weight:600;color:#fff;cursor:pointer}
.save{background:#43a047}
.photo{background:#1e88e5}
.auto-promo{background:#f57c00;margin-top:10px}

.class-title{background:#1e88e5;color:#fff;padding:10px;border-radius:10px;margin-top:15px;display:flex;justify-content:space-between;cursor:pointer}
.class-title i{transition:.3s}
.class-title.open i{transform:rotate(180deg)}
.class-box{display:none}

.student{background:#f9f9f9;padding:10px;border-radius:12px;display:flex;gap:10px;margin-top:8px}
.student img{width:60px;height:60px;border-radius:50%;object-fit:cover}
.info{flex:1;font-size:13px}
.actions i{font-size:18px;cursor:pointer;margin:4px}
.call{color:#2e7d32}
.edit{color:#1e88e5}
.delete{color:#e53935}
</style>
</head>

<body>
<!-- ADMIN PIN MODAL -->
<div id="adminPinBox" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);justify-content:center;align-items:center;z-index:10000">
  <div style="background:#fff;padding:20px;border-radius:12px;text-align:center;width:300px">
    <h3>Admin PIN</h3>
    <input type="password" id="adminPin" placeholder="Enter PIN" style="padding:10px;width:100%">
    <br><br>
    <button class="btn save" onclick="checkAdminPin()">Unlock</button>
  </div>
</div>

<!-- SPLASH SCREEN -->
<div id="splash">
  <img src="images/splash.png" alt="Nairrataat School">
  <h1>Nairrataat School</h1>
</div>

<div class="container">
  <div class="header">
    <h2>Nairrataat School</h2>
    <p>Student Register</p>
  </div>

  <!-- PHOTO UPLOAD -->
  <div class="photo-box">
    <img id="preview" src="images/avatar.png">
    <label class="btn photo">
      <i class="fa fa-camera"></i> Take Photo
      <input type="file" accept="image/*" capture="environment" onchange="loadPhoto(event)" style="display:none">
    </label>
  </div>

  <!-- STUDENT DETAILS -->
  <div class="input-box"><i class="fa fa-user"></i><input id="name" placeholder="Student Name"></div>
  <div class="input-box"><i class="fa fa-id-card"></i><input id="adm" placeholder="Admission Number"></div>

  <!-- ADMIN ONLY FIELDS -->
  <div id="adminFields" style="display:none">
    <div class="input-box"><i class="fa fa-hashtag"></i><input id="uapi" placeholder="UAPI Number"></div>
    <div class="input-box"><i class="fa fa-file"></i><input id="assessment" placeholder="Assessment Number"></div>
    <button class="btn auto-promo" onclick="autoPromote()">Auto Promote Students</button>
  </div>

  <!-- CLASS & GENDER -->
  <div class="input-box"><i class="fa fa-school"></i>
    <select id="className">
      <option value="">Select Class</option>
      <option>PP1</option><option>PP2</option>
      <option>Grade 1</option><option>Grade 2</option>
      <option>Grade 3</option><option>Grade 4</option>
      <option>Grade 5</option><option>Grade 6</option>
      <option>Grade 7</option><option>Grade 8</option><option>Grade 9</option>
    </select>
  </div>

  <div class="input-box"><i class="fa fa-venus-mars"></i>
    <select id="gender">
      <option value="">Gender</option>
      <option>Male</option>
      <option>Female</option>
    </select>
  </div>

  <div class="input-box"><i class="fa fa-user-shield"></i><input id="parent" placeholder="Parent / Guardian"></div>
  <div class="input-box"><i class="fa fa-phone"></i><input id="phone" placeholder="Phone"></div>

  <button class="btn save" onclick="saveStudent()">Save Student</button>

  <div id="list"></div>
</div>

<button class="btn photo" onclick="showAdminPin()">Admin Unlock</button>

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ================= FIREBASE CONFIG =================
const firebaseConfig = {
  apiKey: "AIzaSyChctZH2ZEDN1OEeBYcgMyL83xLPypvYYA",
  authDomain: "nairrataat.firebaseapp.com",
  projectId: "nairrataat",
  storageBucket: "nairrataat.appspot.com",
  messagingSenderId: "899075148431",
  appId: "1:899075148431:web:81a52456bca70e4865befa"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();


// ================= VARIABLES =================
const name = document.getElementById("name");
const adm = document.getElementById("adm");
const uapi = document.getElementById("uapi");
const assessment = document.getElementById("assessment");
const className = document.getElementById("className");
const gender = document.getElementById("gender");
const parent = document.getElementById("parent");
const phone = document.getElementById("phone");
const preview = document.getElementById("preview");

let photoData = "";
let edit = -1;
let students = [];
let role = "teacher"; // default role
const ADMIN_PIN = "2034";

// ================= PHOTO =================
function loadPhoto(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(event){
    const img = new Image();
    img.onload = function(){
      const canvas = document.createElement("canvas");
      const maxSize = 300; // max width/height
      let width = img.width;
      let height = img.height;

      if(width > height){
        if(width > maxSize){
          height *= maxSize / width;
          width = maxSize;
        }
      } else {
        if(height > maxSize){
          width *= maxSize / height;
          height = maxSize;
        }
      }

      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);

      // 0.7 = compression quality (you can reduce to 0.6 if needed)
      photoData = canvas.toDataURL("image/jpeg", 0.7);
      preview.src = photoData;
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
}

// ================= SAVE STUDENT =================
function saveStudent() {
  if(name.value.trim()==="") return alert("Enter student name");
  if(className.value==="") return alert("Select class");

  const docId = edit !== -1 ? students[edit].adm || students[edit].name : (adm.value || name.value);
  const docIdClean = docId.replace(/\s+/g,"_");

  const student = {
    name: name.value,
    adm: adm.value,
    class: className.value,
    gender: gender.value,
    parent: parent.value,
    phone: phone.value,
    photo: photoData || preview.src || "images/avatar.png",
    uapi: role==="admin" ? uapi.value : "",
    assessment: role==="admin" ? assessment.value : ""
  };

  db.collection("students").doc(docIdClean).set(student)
    .then(()=>{
      alert("Student saved successfully");
      clearFields();
    })
    .catch(err=>alert("Save error: " + err.message));
}

// ================= CLEAR FORM =================
function clearFields(){
  name.value=adm.value=uapi.value=assessment.value=parent.value=phone.value="";
  className.value=gender.value="";
  preview.src="images/avatar.png";
  photoData="";
  edit=-1;
}

// ================= SHOW STUDENTS =================
function show(){
  const list = document.getElementById("list");
  list.innerHTML="";
  const grouped = {};
  students.forEach((s,i)=> (grouped[s.class]=grouped[s.class]||[]).push({...s,i}));

  for(let c in grouped){
    const id = c.replace(/\s/g,"");
    list.innerHTML += `
      <div class="class-title" onclick="toggle('${id}', this)">
        ${c}<i class="fa fa-chevron-down"></i>
      </div>
      <div class="class-box" id="${id}"></div>
    `;
    const box = document.getElementById(id);
    grouped[c].forEach(s=>{
      box.innerHTML += `
<div class="student">
  <img src="${s.photo||'images/avatar.png'}">
  <div class="info">
    <b>${s.name}</b><br>
    Adm: ${s.adm}<br>
    ${role==='admin' ? `UAPI: ${s.uapi||''}<br>Assessment: ${s.assessment||''}<br>`:``}
    ${s.parent}<br>
    ${s.phone}
  </div>
  ${role==='admin' ? `<div class="actions">
    <a href="tel:${s.phone}"><i class="fa fa-phone call"></i></a>
    <i class="fa fa-pen edit" onclick="editStudent(${s.i})"></i>
    <i class="fa fa-trash delete" onclick="del(${s.i})"></i>
  </div>` : ``}
</div>`;
    });
  }
}

// ================= TOGGLE =================
function toggle(id,h){
  const b=document.getElementById(id);
  const open=b.style.display==="block";
  b.style.display=open?"none":"block";
  h.classList.toggle("open",!open);
}

// ================= EDIT =================
function editStudent(i){
  if(role!=="admin") return;
  const s = students[i];
  name.value=s.name; adm.value=s.adm; className.value=s.class; gender.value=s.gender;
  parent.value=s.parent; phone.value=s.phone; preview.src=s.photo||preview.src;
  photoData=s.photo; uapi.value=s.uapi||""; assessment.value=s.assessment||"";
  edit=i;
}

// ================= DELETE =================
function del(i){
  if(role!=="admin") return;
  if(!confirm("Delete student?")) return;
  const s = students[i];
  const docId = (s.adm || s.name).replace(/\s+/g,"_");

  db.collection("students").doc(docId).delete()
    .then(()=>alert("Student deleted"))
    .catch(err=>alert(err.message));
}

// ================= ADMIN PIN =================
function showAdminPin(){document.getElementById("adminPinBox").style.display="flex";}
function checkAdminPin(){
  const pin = document.getElementById("adminPin").value;
  if(pin===ADMIN_PIN){
    role="admin"; document.getElementById("adminFields").style.display="block";
    document.getElementById("adminPinBox").style.display="none";
    alert("Admin mode enabled");
    show();
  } else alert("Wrong PIN");
}

// ================= AUTO PROMOTE =================
function autoPromote(){
  if(!confirm("Promote all students to next class?")) return;

  const classOrder = ["PP1","PP2","Grade 1","Grade 2","Grade 3","Grade 4","Grade 5","Grade 6","Grade 7","Grade 8","Grade 9"];
  students.forEach(s=>{
    let idx = classOrder.indexOf(s.class);
    if(idx!==-1 && idx<classOrder.length-1){
      s.class = classOrder[idx+1];
    }
  });

  students.forEach(s=>{
    const docId = (s.adm || s.name).replace(/\s+/g,"_");
    db.collection("students").doc(docId).set(s).catch(err=>console.error(err));
  });

  show();
  alert("Students promoted successfully! PP1 is empty for new intake.");
}

// ================= FIRESTORE REALTIME =================
db.collection("students").onSnapshot(snapshot=>{
  students=[];
  snapshot.forEach(doc=>students.push(doc.data()));
  show();
});

// ================= INITIAL LOAD =================
window.onload = () => {
  setTimeout(()=>document.getElementById("splash").remove(), 3000);
  show(); // render UI immediately
};
</script>
</body>
  </html>
